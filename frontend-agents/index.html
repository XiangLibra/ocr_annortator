<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Multi-Agent OCR Backend (Vue CDN)</title>
  <link rel="stylesheet" href="https://unpkg.com/modern-css-reset/dist/reset.min.css">
  <style>
    body { font-family: "Segoe UI","PingFang TC","Noto Sans TC",sans-serif; background:#f5f7fb; color:#1f1f1f; margin:0; }
    .shell { max-width: 1200px; margin: 0 auto; padding: 20px 16px 48px; }
    header { display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:16px; }
    h1 { margin:0; font-size:22px; }
    .card { background:#fff; border:1px solid #e3e7ef; border-radius:12px; padding:14px; box-shadow:0 6px 18px rgba(16,30,54,0.06); margin-bottom:14px; }
    input, select, button, textarea { font:inherit; }
    button { cursor:pointer; border:1px solid #cfd6e4; background:linear-gradient(180deg,#fdfefe,#eef3fb); border-radius:10px; padding:8px 12px; transition:all .15s ease; }
    button:hover { border-color:#9fb4dc; box-shadow:0 6px 16px rgba(76,119,187,.15); }
    button:disabled { opacity:.6; cursor:not-allowed; box-shadow:none; }
    textarea { width:100%; border-radius:10px; border:1px solid #cfd6e4; padding:8px; box-sizing:border-box; min-height:120px; }
    .grid { display:grid; grid-template-columns: repeat(auto-fit,minmax(260px,1fr)); gap:12px; }
    .list { border:1px solid #e3e7ef; border-radius:10px; padding:10px; background:#fff; }
    .badge { display:inline-block; padding:2px 8px; border-radius:6px; background:#eef3fb; border:1px solid #d6ddea; color:#244; font-size:12px; }
    pre { background:#0c1116; color:#e6edf3; padding:10px; border-radius:10px; overflow:auto; }
    .diff { white-space:pre-wrap; word-break:break-word; line-height:1.6; }
    .diff span.add { background:#e6ffed; color:#22863a; border-radius:4px; padding:0 2px; }
    .diff span.del { background:#ffeef0; color:#cb2431; text-decoration:line-through; border-radius:4px; padding:0 2px; }
    .wrap { white-space: pre-wrap; word-break: break-word; }
    .markdown { background:#0c1116; color:#e6edf3; padding:10px; border-radius:10px; white-space:pre-wrap; word-break:break-word; }
  </style>
</head>
<body>
  <div id="app" class="shell">
    <header>
      <h1>ğŸ¤– Multi-Agent OCR Backend</h1>
      <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
        <label>API ä½å€</label>
        <input v-model="apiBase" style="width:260px; padding:6px 8px; border:1px solid #cfd6e4; border-radius:8px;">
      </div>
    </header>

    <div class="card">
      <h3 style="margin:0 0 8px;">âœï¸ å»ºç«‹ / æ›´æ–° Agent</h3>
      <div class="grid">
        <div class="list">
          <h4 style="margin:0 0 6px;">æ–°å¢ Agent</h4>
          <input v-model="form.name" placeholder="åç¨±" style="width:100%; margin-bottom:6px; padding:6px; border:1px solid #cfd6e4; border-radius:8px;">
          <input v-model="form.model" placeholder="æ¨¡å‹ (llama3.2:3b...)" style="width:100%; margin-bottom:6px; padding:6px; border:1px solid #cfd6e4; border-radius:8px;">
          <input v-model.number="form.temperature" type="number" step="0.1" min="0" max="1.2" placeholder="temperature" style="width:100%; margin-bottom:6px; padding:6px; border:1px solid #cfd6e4; border-radius:8px;">
          <textarea v-model="form.prompt" placeholder="ç³»çµ±æç¤ºè©"></textarea>
          <button style="margin-top:8px;" @click="createAgent">å»ºç«‹ Agent</button>
        </div>
        <div class="list">
          <h4 style="margin:0 0 6px;">Router / Evaluator Prompt</h4>
          <label>Router</label>
          <textarea v-model="routerPrompt" style="min-height:80px;"></textarea>
          <label style="margin-top:6px; display:block;">Evaluator</label>
          <textarea v-model="evaluatorPrompt" style="min-height:80px;"></textarea>
          <button style="margin-top:8px;" @click="savePrompts">ä¿å­˜ Prompt</button>
        </div>
      </div>
    </div>

    <div class="card">
      <h3 style="margin:0 0 8px;">ğŸ“‹ Agents</h3>
      <div style="display:flex; flex-wrap:wrap; gap:8px;">
        <div v-for="a in agents" :key="a.name" class="list" style="min-width:260px;">
          <div style="display:flex; justify-content:space-between; align-items:center; gap:6px;">
            <strong>{{ a.name }}</strong>
            <span class="badge">{{ a.model }} Â· temp {{ a.temperature }}</span>
          </div>
          <div style="margin:6px 0; color:#3b4148; white-space:pre-wrap; word-break:break-word;">{{ a.system_prompt }}</div>
          <button @click="removeAgent(a.name)" style="background:#ffeef0; border-color:#f5c2c7; color:#a61b29;">åˆªé™¤</button>
        </div>
      </div>
    </div>

    <div class="card">
      <h3 style="margin:0 0 8px;">ğŸ§  åŸ·è¡Œ</h3>
      <div class="grid">
        <div class="list">
          <label>ç­–ç•¥</label>
          <select v-model="run.strategy" style="width:100%; padding:6px; border:1px solid #cfd6e4; border-radius:8px; margin-bottom:6px;">
            <option value="auto">auto (router æ±ºå®š)</option>
            <option value="single">single</option>
            <option value="parallel">parallel</option>
            <option value="sequential">sequential</option>
          </select>
          <label>é¸æ“‡ Agentï¼ˆå–®/ä¸¦è¡Œ/åºåˆ—ç”¨ï¼Œç•™ç©º=å…¨éƒ¨/è·¯ç”±æ±ºå®šï¼‰</label>
          <div style="display:flex; flex-wrap:wrap; gap:6px;">
            <label v-for="a in agents" :key="a.name" style="display:flex; gap:4px; align-items:center;">
              <input type="checkbox" :value="a.name" v-model="run.selectedAgents"> {{ a.name }}
            </label>
          </div>
        </div>
        <div class="list">
          <label>è¼¸å…¥å…§å®¹</label>
          <textarea
            v-model="run.text"
            placeholder="ä¾‹ï¼šæ¯”è¼ƒæ–‡ä»¶Aèˆ‡Bçš„å·®ç•°ï¼Œåˆ—å‡ºä¸»è¦è®ŠåŒ–ä¸¦çµ¦å‡ºçµè«–ã€‚æˆ–ï¼šè«‹æ‘˜è¦é€™å…©ä»½å ±å‘Šä¸¦æŒ‡å‡ºçŸ›ç›¾ä¹‹è™•ã€‚"
          ></textarea>
          <label style="margin-top:6px;">Context (JSONï¼Œå¯ç©º)</label>
          <textarea v-model="run.context" placeholder='{"meta":"info"}' style="min-height:80px;"></textarea>
          <button style="margin-top:8px;" @click="execute" :disabled="loading">åŸ·è¡Œ</button>
        </div>
      </div>
      <div v-if="result" style="margin-top:12px;">
        <div class="list">
          <div class="wrap"><strong>ç­–ç•¥ï¼š</strong> {{ result.strategy_used }} | <strong>æ±ºç­–ï¼š</strong> {{ result.decision }}</div>
          <div v-if="result.payload.final_result !== undefined || result.payload.result !== undefined" style="margin:8px 0;">
            <div class="badge">Final / Result</div>
            <div style="display:flex; align-items:center; gap:8px; margin:6px 0;">
              <span>AI è¼¸å‡º</span>
              <button type="button" @click="editingFinal = !editingFinal">{{ editingFinal ? "é—œé–‰ç·¨è¼¯" : "ğŸ“ ç·¨è¼¯" }}</button>
            </div>
            <div class="markdown" v-html="renderedFinal"></div>
            <div v-if="editingFinal" style="margin-top:8px;">
              <textarea v-model="editedFinal" style="min-height:140px;"></textarea>
              <div class="badge" style="margin-top:6px;">å·®ç•° Diff</div>
              <pre class="diff">
<template v-for="(p,idx) in finalDiffParts" :key="idx">
  <span v-if="p.added" class="add">{{ p.value }}</span>
  <span v-else-if="p.removed" class="del">{{ p.value }}</span>
  <span v-else>{{ p.value }}</span>
</template>
              </pre>
            </div>
          </div>
          <div v-if="result.payload.individual_results">
            <div class="badge">Individual</div>
            <div v-for="(v,k) in result.payload.individual_results" :key="k" class="list" style="margin-top:6px;">
              <strong>{{ k }}</strong>
              <pre>{{ v }}</pre>
            </div>
          </div>
          <div v-if="result.payload.steps">
            <div class="badge">Sequential Steps</div>
            <div v-for="(s,idx) in result.payload.steps" :key="idx" class="list" style="margin-top:6px;">
              <strong>{{ s.agent }}</strong>
              <div>Input:</div>
              <pre>{{ s.input }}</pre>
              <div>Output:</div>
              <pre>{{ s.output }}</pre>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/diff@7/dist/diff.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script>
    const { createApp, ref, computed } = Vue;
    createApp({
      setup() {
        const apiBase = ref(location.origin);
        const agents = ref([]);
        const routerPrompt = ref("");
        const evaluatorPrompt = ref("");
        const form = ref({ name:"", model:"llama3.2:3b", temperature:0.1, prompt:"" });
        const run = ref({ strategy:"auto", selectedAgents:[], text:"", context:"" });
        const result = ref(null);
        const loading = ref(false);
        const originalFinal = ref("");
        const editedFinal = ref("");
        const editingFinal = ref(false);

        const finalDiffParts = computed(() => Diff.diffWordsWithSpace(originalFinal.value || "", editedFinal.value || ""));
        const renderedFinal = computed(() => marked.parse(((editedFinal.value || originalFinal.value || "")).trim()));

        async function fetchAgents() {
          const res = await axios.get(apiBase.value + "/api/agents");
          agents.value = res.data;
        }
        async function fetchPrompts() {
          const res = await axios.get(apiBase.value + "/api/router_prompt");
          routerPrompt.value = res.data.router_prompt || "";
          evaluatorPrompt.value = res.data.evaluator_prompt || "";
        }
        async function createAgent() {
          if (!form.value.name || !form.value.prompt) return alert("è«‹å¡«åç¨±èˆ‡æç¤ºè©");
          await axios.post(apiBase.value + "/api/agents", {
            name: form.value.name,
            system_prompt: form.value.prompt,
            model: form.value.model,
            temperature: form.value.temperature
          });
          form.value = { name:"", model:"llama3.2:3b", temperature:0.1, prompt:"" };
          fetchAgents();
        }
        async function removeAgent(name) {
          if (!confirm(`åˆªé™¤ ${name}?`)) return;
          await axios.delete(apiBase.value + "/api/agents/" + encodeURIComponent(name));
          fetchAgents();
        }
        async function savePrompts() {
          await axios.put(apiBase.value + "/api/router_prompt", {
            router_prompt: routerPrompt.value,
            evaluator_prompt: evaluatorPrompt.value
          });
          alert("å·²æ›´æ–°");
        }
        async function execute() {
          if (!run.value.text.trim()) return alert("è«‹è¼¸å…¥å…§å®¹");
          loading.value = true;
          try {
            let ctx = undefined;
            if (run.value.context && run.value.context.trim()) {
              try { ctx = JSON.parse(run.value.context); } catch { alert("Context ä¸æ˜¯åˆæ³• JSON"); loading.value=false; return; }
            }
            const res = await axios.post(apiBase.value + "/api/run", {
              input_text: run.value.text,
              strategy: run.value.strategy,
              agents: run.value.selectedAgents,
              context: ctx
            });
            result.value = res.data;
            originalFinal.value = res.data?.payload?.final_result ?? res.data?.payload?.result ?? "";
            editedFinal.value = originalFinal.value;
            editingFinal.value = false;
          } finally {
            loading.value = false;
          }
        }

        fetchAgents(); fetchPrompts();
        return { apiBase, agents, routerPrompt, evaluatorPrompt, form, run, result, loading,
                 createAgent, removeAgent, savePrompts, execute,
                 originalFinal, editedFinal, editingFinal, finalDiffParts, renderedFinal };
      }
    }).mount("#app");
  </script>
</body>
</html>
